workflows:
  build:
    name: Build Android
    environment:
      vars:
        SPOTIFY_SECRETS: "$SPOTIFY_SECRETS"
        LASTFM_API_KEY: "$LASTFM_API_KEY"
        LASTFM_API_SECRET: "$LASTFM_API_SECRET"
        ENABLE_UPDATE_CHECK: "$ENABLE_UPDATE_CHECK"
        RELEASE_CHANNEL: "$RELEASE_CHANNEL"
        HIDE_DONATIONS: "$HIDE_DONATIONS"
        DISABLE_SPOTIFY_IMAGES: "$DISABLE_SPOTIFY_IMAGES"
      flutter: stable
      android_sdk: latest
    scripts:
      - name: Install Dependencies
        script: |
          flutter pub get
      - name: Generate Code
        script: |
          echo "SPOTIFY_SECRETS=$SPOTIFY_SECRETS" > .env
          echo "LASTFM_API_KEY=$LASTFM_API_KEY" >> .env
          echo "LASTFM_API_SECRET=$LASTFM_API_SECRET" >> .env
          echo "ENABLE_UPDATE_CHECK=$ENABLE_UPDATE_CHECK" >> .env
          echo "RELEASE_CHANNEL=$RELEASE_CHANNEL" >> .env
          echo "HIDE_DONATIONS=$HIDE_DONATIONS" >> .env
          echo "DISABLE_SPOTIFY_IMAGES=$DISABLE_SPOTIFY_IMAGES" >> .env
          dart run build_runner build --delete-conflicting-outputs
          rm .env
      - name: Build AppBundle with Increased Memory
        script: |
          export GRADLE_OPTS="-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError"
          flutter build appbundle --debug --stacktrace
    artifacts:
      - build/app/outputs/bundle/**/*.aab